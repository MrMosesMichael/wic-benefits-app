# A3.1 Code Review - Bugs Found

## Summary
A3.1 implementation provides good structure but has **6 critical bugs** that prevent the pipeline from working end-to-end. All bugs are in data handling and type mismatches.

---

## Critical Bugs

### BUG #1: Mock Data Missing Coordinates
**File**: `src/services/retailer/scrapers/MichiganRetailerScraper.ts:129-130` (and all other scrapers)
**Severity**: CRITICAL - Pipeline breaks
**Issue**: Mock data returns `latitude: undefined, longitude: undefined` but normalization requires both

```typescript
// Current (broken):
latitude: undefined,
longitude: undefined,

// Should be:
latitude: 42.3314,  // Detroit, MI approximate
longitude: -83.0458,
```

**Impact**: `normalizeRetailerData()` returns `null` for all records since coordinates are required (normalization.utils.ts:28-32)

**Fix**: Add realistic coordinates to mock data for all 4 state scrapers

---

### BUG #2: Type Mismatch - Invalid Field in Mock Data
**File**: `src/services/retailer/scrapers/*.ts` (all 4 state scrapers)
**Severity**: HIGH - TypeScript error
**Issue**: Mock data includes `verified: false` field which doesn't exist in `WICRetailerRawData` interface

```typescript
// Current (broken):
verified: false,  // ‚ùå Not in interface

// Remove this field entirely
```

**Interface Definition** (types/retailer.types.ts:71):
- Defines `verified?: boolean` ‚úì But...
- Actually shows `lastVerified?: string` in the real data structure

**Fix**: Remove `verified` field from all mock data objects

---

### BUG #3: Missing timezone is Non-Optional
**File**: `src/services/retailer/types/retailer.types.ts:115`
**Severity**: MEDIUM - Type mismatch
**Issue**: `NormalizedRetailerData.timezone` is non-optional but not guaranteed in raw data

```typescript
// In interface (line 115):
timezone: string;  // ‚ùå Non-optional

// But in normalization (line 64):
timezone: getTimezoneForState(rawData.state),  // ‚úì Always set

// This is actually OK since it's always set by getTimezoneForState()
```

**Status**: No action needed - implementation is correct, just marking for awareness

---

### BUG #4: Incomplete Enumeration Match
**File**: `src/services/retailer/types/retailer.types.ts:27`
**Severity**: MEDIUM - Type mismatch
**Issue**: `RetailerProcessorType` is `'fis' | 'conduent' | 'state' | 'jpmorgan' | 'other'` but research document and code use different names

**In scrapers**:
- Michigan: `processorType: 'fis'` ‚úì
- North Carolina: `processorType: 'conduent'` ‚úì
- Florida: `processorType: 'fis'` ‚úì
- Oregon: `processorType: 'state'` ‚úì

**Status**: Type definitions are correct, scrapers match

---

### BUG #5: Geocoding Always Fails
**File**: `src/services/retailer/RetailerDataService.ts:130-162`
**Severity**: MEDIUM - Not implemented
**Issue**: `geocodeAddresses()` method is a stub that always returns `success: false`

```typescript
results.push({
  success: false,
  error: 'Geocoding not yet implemented',
  source: 'google',
});
```

**Impact**: Normalization won't work without coordinates, but geocoding is stubbed

**Fix**: Since this is marked TODO and coordinates are in mock data, this is acceptable for MVP but needs tracking

---

### BUG #6: Enrichment Always Fails
**File**: `src/services/retailer/RetailerDataService.ts:169-191`
**Severity**: LOW - Not implemented
**Issue**: `enrichData()` method is a stub that always returns `success: false`

**Impact**: Phone numbers, hours won't be enriched from Google Places

**Fix**: Acceptable for MVP - mark as TODO

---

## Validation Issues

### Issue #7: Hours Parsing Incomplete
**File**: `src/services/retailer/utils/normalization.utils.ts:219-236`
**Severity**: MEDIUM - Feature incomplete
**Issue**: `parseHoursString()` is stubbed and always returns `undefined`

```typescript
// Current (line 229-231):
if (!hoursStr || hoursStr.trim() === '') {
  return undefined;
}
// TODO: Implement robust hours parsing
return undefined;  // Always returns undefined!
```

**Impact**: Operating hours will never be populated

**Fix**: OK for MVP, but document that hours will be empty until Google Places enrichment is implemented

---

## Async/Error Handling Issues

### Issue #8: Promise Rejection Not Handled
**File**: `src/services/retailer/RetailerDataService.ts:33-74`
**Severity**: LOW - Catch block exists
**Issue**: If scraper throws, error is caught and logged but not propagated clearly

**Status**: Actually handled correctly with try/catch returning error results

---

## Missing Tests
**Severity**: MEDIUM
**Issue**: No test framework specified but tests are needed for:

1. **Data validation tests**
   - Mock data structure matches interface
   - Normalization handles missing fields gracefully
   - Deduplication correctly identifies duplicates

2. **Error handling tests**
   - Network failures are handled
   - Invalid data is rejected
   - Geocoding fallback works

3. **Pipeline tests**
   - Full scrape ‚Üí normalize ‚Üí deduplicate flow
   - Quality metrics calculation
   - State-specific processor types are preserved

4. **Scraper tests**
   - Each state scraper returns valid structure
   - Validation method works
   - Rate limiting is respected

---

## Summary of Fixes Required

| Priority | Bug | File | Fix |
|----------|-----|------|-----|
| üî¥ CRITICAL | Mock data missing coordinates | `*/MichiganRetailerScraper.ts` + 3 others | Add realistic lat/lng to mock data |
| üî¥ CRITICAL | Invalid `verified` field | `*/MichiganRetailerScraper.ts` + 3 others | Remove `verified: false` from mock |
| üü° MEDIUM | Hours parsing stubbed | `normalization.utils.ts` | Document as TODO for MVP |
| üü° MEDIUM | Geocoding stubbed | `RetailerDataService.ts` | Document as TODO for MVP |
| üü¢ LOW | No tests | N/A | Create test suite (separate task) |

---

## Code Quality Notes

### Strengths
‚úÖ Good type definitions with interfaces
‚úÖ Clear separation of concerns (scrapers, normalization, service)
‚úÖ Consistent error handling patterns
‚úÖ State-specific configuration isolated
‚úÖ Good code comments and TODO markers
‚úÖ Proper async/await usage

### Areas for Improvement
‚ö†Ô∏è No test framework
‚ö†Ô∏è Mock data doesn't match production format
‚ö†Ô∏è TODO items not tracked in external system
‚ö†Ô∏è No logging framework (using console.log)
‚ö†Ô∏è No rate limiting implementation (just delay)
‚ö†Ô∏è Timezone detection is simplified (all of Florida uses one zone)

---

## Next Steps

1. **Fix critical bugs** (BUG #1, #2)
   - Add realistic coordinates to mock data
   - Remove invalid `verified` field

2. **Document limitations** in README
   - Geocoding is stubbed
   - Hours parsing is stubbed
   - Timezone is simplified

3. **Create test suite** (A3.1 final verification)
   - Unit tests for normalization
   - Integration tests for full pipeline
   - Scraper validation tests

4. **Implement A3.2-A3.5** in subsequent tasks
