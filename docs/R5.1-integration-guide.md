# R5.1 Balance Discrepancy Warnings - Integration Guide

## Overview

This guide explains how to integrate the benefit balance validation service into the WIC Benefits App.

## Quick Start

### 1. Basic Setup

The service is ready to use out of the box with default thresholds:

```typescript
import { benefitValidationService } from '@/lib/services/benefitValidation';
```

### 2. Validate Benefits

```typescript
// After fetching benefits from API
const benefits = await api.getBenefits(householdId);
const result = benefitValidationService.validateAllBenefits(benefits);

if (result.hasWarnings) {
  // Show warnings to user
  console.log('Found', result.warnings.length, 'warnings');
}
```

### 3. Display Warnings in UI

```tsx
import { useBenefitValidation } from '@/lib/hooks/useBenefitValidation';
import { BenefitValidationList } from '@/components/BenefitValidationAlert';

function BenefitsScreen() {
  const { participant } = useParticipant();
  const { warnings, hasWarnings } = useBenefitValidation(
    participant.benefits,
    { autoValidate: true, minSeverity: 'medium' }
  );

  return (
    <View>
      {hasWarnings && (
        <BenefitValidationList
          warnings={warnings}
          onResolveWarning={handleResolve}
        />
      )}
      {/* Rest of benefits UI */}
    </View>
  );
}
```

## Integration Points

### A. Manual Benefit Entry Screen

**When**: After user manually enters benefit amounts
**Where**: `app/app/benefits/manual-entry.tsx`

```tsx
import { useSingleBenefitValidation } from '@/lib/hooks/useBenefitValidation';

function ManualBenefitEntry({ participant, category }) {
  const [amount, setAmount] = useState('');
  const { warning, validate } = useSingleBenefitValidation(undefined, {
    autoValidate: false
  });

  const handleSave = async () => {
    const benefitData = {
      category,
      categoryLabel: getCategoryLabel(category),
      totalAmount: parseFloat(amount),
      availableAmount: parseFloat(amount),
      inCartAmount: 0,
      consumedAmount: 0,
      unit: getUnit(category),
    };

    // Validate before saving
    const validationWarning = validate(benefitData);

    if (validationWarning && validationWarning.severity === 'high') {
      // Show confirmation dialog
      const confirmed = await confirmHighSeverityWarning(validationWarning);
      if (!confirmed) return;
    }

    // Save to backend
    await saveBenefit(benefitData);
  };

  return (
    <View>
      {/* Input fields */}
      {warning && (
        <BenefitValidationAlert warning={warning} />
      )}
      <Button onPress={handleSave}>Save</Button>
    </View>
  );
}
```

### B. Benefits Overview Screen

**When**: On screen load and periodic refresh
**Where**: `app/app/benefits/index.tsx`

```tsx
import { useBenefitValidation } from '@/lib/hooks/useBenefitValidation';

function BenefitsOverview() {
  const { household } = useHousehold();

  // Validate all participants' benefits
  const allBenefits = household.participants.flatMap(p => p.benefits);
  const { warnings, hasHighSeverityWarnings } = useBenefitValidation(
    allBenefits,
    { autoValidate: true, minSeverity: 'medium' }
  );

  return (
    <ScrollView>
      {hasHighSeverityWarnings && (
        <Alert severity="error">
          Critical balance issues detected. Please review.
        </Alert>
      )}

      <BenefitValidationList warnings={warnings} />

      {/* Participant benefits display */}
    </ScrollView>
  );
}
```

### C. Post-Checkout Validation

**When**: After user completes checkout
**Where**: `app/app/cart/checkout.tsx`

```tsx
import { benefitValidationService, convertMultipleBenefits } from '@/lib/services/benefitValidation';

async function handleCheckout(cart: Cart) {
  // 1. Process checkout
  const checkoutResult = await api.checkout(cart.id);

  // 2. Fetch updated benefits
  const updatedBenefits = await api.getBenefits(household.id);

  // 3. Validate all participants
  const allBenefits = updatedBenefits.participants.flatMap(p =>
    convertMultipleBenefits(p.benefits)
  );

  const validation = benefitValidationService.validateAllBenefits(allBenefits);

  // 4. Show success with optional warnings
  if (validation.hasWarnings) {
    showCheckoutSuccess({
      warnings: validation.warnings,
      message: 'Checkout complete, but some balance discrepancies detected.'
    });
  } else {
    showCheckoutSuccess({
      message: 'Checkout complete! All balances verified.'
    });
  }
}
```

### D. Purchase Logging

**When**: After logging manual purchase
**Where**: `app/app/benefits/log-purchase.tsx`

```tsx
async function logPurchase(participantId, category, quantity, unit) {
  // Log purchase to backend
  const result = await purchaseService.logPurchase({
    participantId,
    category,
    quantity,
    unit
  });

  // Validate the updated benefit
  const benefit = convertToBenefitBalance(result.benefit);
  const warning = benefitValidationService.validateBenefit(benefit);

  if (warning) {
    // Show warning but allow continuation
    showWarning({
      title: 'Balance Warning',
      message: warning.message,
      severity: warning.severity
    });
  }

  return result;
}
```

### E. Background Validation (Optional)

**When**: Periodic background checks
**Where**: `app/lib/services/backgroundTasks.ts`

```tsx
import { benefitValidationService } from '@/lib/services/benefitValidation';

async function validateBenefitsBackground() {
  const household = await getHousehold();
  const allBenefits = household.participants.flatMap(p => p.benefits);

  const result = benefitValidationService.validateAllBenefits(allBenefits);

  // Only notify for high severity issues
  const criticalWarnings = result.warnings.filter(w => w.severity === 'high');

  if (criticalWarnings.length > 0) {
    // Send push notification
    await sendNotification({
      title: 'Balance Issue Detected',
      body: `${criticalWarnings.length} critical balance discrepancies found.`,
      data: { warnings: criticalWarnings }
    });
  }
}
```

## Configuration

### Default Thresholds

The default thresholds work for most cases:

```typescript
{
  lowThresholdPercent: 5,      // 5% of total
  mediumThresholdPercent: 10,  // 10% of total
  highThresholdPercent: 20,    // 20% of total
  minimumAbsoluteDiscrepancy: 0.1  // 0.1 units
}
```

### Custom Thresholds

For specific use cases, create a custom validator:

```typescript
import { BenefitValidationService } from '@/lib/services/benefitValidation';

// Stricter validation for high-value benefits
const strictValidator = new BenefitValidationService({
  lowThresholdPercent: 2,
  mediumThresholdPercent: 5,
  highThresholdPercent: 10
});

// For formula (critical item)
const formulaBenefit = participant.benefits.find(b => b.category === 'infant_formula');
const warning = strictValidator.validateBenefit(formulaBenefit);
```

## UI/UX Guidelines

### When to Show Warnings

| Severity | Display Method | Dismissible |
|----------|----------------|-------------|
| Low      | Inline notice, collapsed by default | Yes |
| Medium   | Inline alert, expanded by default | Yes |
| High     | Modal dialog or prominent banner | Yes (with confirmation) |

### Warning Display Examples

#### Low Severity (Inline, Collapsed)
```
â„¹ï¸ Minor discrepancy in Milk balance (Tap to view details)
```

#### Medium Severity (Inline, Expanded)
```
âš ï¸ Warning: Milk balance shows 0.50 gal more than expected
based on recorded usage.

Expected: 1.00 gal | Actual: 1.50 gal

What to do: Double-check your recent Milk purchases to
ensure all are logged correctly.

[Dismiss] [Review Purchases]
```

#### High Severity (Modal/Prominent)
```
ðŸš¨ URGENT: Critical Balance Issue

Eggs balance shows 1.00 doz less than expected based on
recorded usage.

Expected: 2.00 doz | Actual: 1.00 doz | Discrepancy: 33%

You may have logged a purchase twice, or your benefit
balance may need correction.

[Review Transaction History] [Contact Support]
```

## Testing

### Unit Tests

```typescript
import { benefitValidationService } from '@/lib/services/benefitValidation';

describe('Benefit Validation', () => {
  it('should detect missed purchase', () => {
    const benefit = {
      category: 'milk',
      categoryLabel: 'Milk',
      totalAmount: 4,
      availableAmount: 2, // Should be 1
      inCartAmount: 1,
      consumedAmount: 2,
      unit: 'gal'
    };

    const warning = benefitValidationService.validateBenefit(benefit);

    expect(warning).not.toBeNull();
    expect(warning?.severity).toBe('high');
    expect(warning?.discrepancy).toBe(1);
  });
});
```

### Integration Tests

```typescript
it('should validate after checkout', async () => {
  await checkout(cart);
  const benefits = await getBenefits();
  const result = benefitValidationService.validateAllBenefits(benefits);

  expect(result.isValid).toBe(true);
});
```

## Troubleshooting

### Common Issues

**Issue**: Too many false positives
**Solution**: Increase `minimumAbsoluteDiscrepancy` or threshold percentages

**Issue**: Missing real discrepancies
**Solution**: Decrease threshold percentages

**Issue**: Floating point precision errors
**Solution**: Ensure `minimumAbsoluteDiscrepancy` is at least 0.01

## Performance Considerations

- Validation is O(n) where n = number of benefits
- Typical validation time: <1ms per benefit
- Safe to run on every render with React hooks
- Consider debouncing for real-time validation during input

## Next Steps

1. Review integration points above
2. Add validation to manual benefit entry (Priority 1)
3. Add validation to benefits overview (Priority 2)
4. Add post-checkout validation (Priority 3)
5. Configure custom thresholds if needed
6. Test with real user data
7. Monitor warning frequency in analytics

## Support

Questions? Check:
- Full documentation: `/src/lib/services/README.md`
- Code examples: `/src/examples/benefit-validation-example.ts`
- React hooks: `/app/lib/hooks/useBenefitValidation.ts`
