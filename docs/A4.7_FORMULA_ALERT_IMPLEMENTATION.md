# A4.7 - Formula Alert Subscription System Implementation

**Date:** 2026-02-02
**Status:** Complete
**Feature:** Push notification alerts for formula availability

## Overview

Implemented a complete push notification system allowing WIC participants to subscribe to alerts when their formula becomes available at nearby stores. Built on existing database infrastructure from A4.3.

## Architecture

### Backend Services (`/backend/src/services/notifications/`)

1. **NotificationRepository.ts** - Database layer for notification operations
   - Push token management (register, deactivate, retrieve)
   - Subscription CRUD operations with 30-day expiry
   - Notification settings (quiet hours, daily limits)
   - Notification history tracking
   - Deduplication checks (30-minute window)

2. **PushNotificationService.ts** - Expo Push Notification integration
   - Direct HTTPS integration with Expo Push API
   - Token validation (ExponentPushToken/ExpoPushToken formats)
   - Quiet hours enforcement
   - Daily notification limits
   - Invalid token cleanup (DeviceNotRegistered)

3. **FormulaRestockNotificationService.ts** - Business logic orchestration
   - Restock alert generation and batching
   - Subscription expiration reminders (3 days before expiry)
   - Test notification sending
   - Smart notification content generation (1 store, 2 stores, 3+ stores)

### REST API Endpoints (`/backend/src/routes/notifications.ts`)

Registered at `/api/v1/notifications`:

- `POST /register-token` - Register Expo push token for device
- `POST /subscribe` - Subscribe to formula alerts (with optional radius/stores)
- `GET /subscriptions` - Get user's active subscriptions
- `GET /subscriptions/:upc` - Get subscription for specific formula
- `DELETE /subscriptions/:id` - Cancel subscription
- `GET /settings` - Get notification settings
- `PATCH /settings` - Update notification settings
- `POST /test` - Send test notification

### Mobile App Integration

1. **NotificationService** (`/app/lib/services/notificationService.ts`)
   - Expo Notifications setup and configuration
   - Permission request flow
   - Token registration with backend
   - Subscription management
   - Notification listeners (foreground/background)

2. **FormulaAlertButton** (`/app/components/FormulaAlertButton.tsx`)
   - Three states: "Set Alert", "Alert Active", "Loading..."
   - Permission request at point of use
   - Subscription toggle with confirmation dialogs
   - Real-time status updates

3. **App Layout Integration** (`/app/app/_layout.tsx`)
   - Notification listener setup on app launch
   - Deep linking to formula finder on notification tap
   - Launch notification handling

4. **Formula Finder Integration** (`/app/app/formula/index.tsx`)
   - Alert button integrated after "View Alternatives"
   - Uses device ID as user identifier
   - Passes search radius to subscription

## Key Design Decisions

### User Identification
- Uses `Constants.deviceId` or `Constants.sessionId` as user ID
- No authentication required (consistent with app design)
- Device-based tracking enables multi-device support

### Permission Flow
- Permission requested at point of use (not on app launch)
- Clear value proposition: "Get notified when formula becomes available"
- Test notification sent immediately after registration

### Subscription Lifecycle
- 30-day automatic expiry (prevents stale subscriptions)
- 3-day expiration reminder via push notification
- User can re-subscribe to extend

### Notification Logic
- 30-minute deduplication window (prevents spam)
- Quiet hours support (default 10 PM - 8 AM)
- Daily notification limit (default 10/day)
- Batching support for multiple stores

### Data Flow
1. User taps "Set Alert" on formula screen
2. App requests notification permissions
3. App gets Expo push token
4. App registers token with backend
5. Backend sends test notification
6. User receives confirmation

When formula becomes available:
1. Shortage detection system identifies restock
2. FormulaRestockNotificationService queries active subscriptions
3. Service checks user settings (quiet hours, limits, deduplication)
4. PushNotificationService sends to Expo API
5. Notification delivered to user's device
6. User taps notification → deep links to formula finder

## Internationalization

### English Strings (`en.json`)
```json
"formulaAlerts": {
  "setAlert": "Set Alert",
  "alertActive": "Alert Active",
  "loading": "Loading...",
  "permissionRequired": "Notification Permission Required",
  "permissionMessage": "To receive formula alerts...",
  "alertSet": "Formula Alert Set!",
  "alertSetMessage": "You'll be notified when {{formula}} becomes available...",
  // ... (16 total strings)
}
```

### Spanish Strings (`es.json`)
- Complete translations for all alert-related UI
- Matches WIC program's 40% Spanish-speaking user base

## Database Schema (Existing from A4.3)

Tables used:
- `push_tokens` - Device push tokens (active/inactive)
- `notification_subscriptions` - User formula subscriptions
- `subscription_stores` - Optional specific stores to monitor
- `notification_settings` - User preferences (quiet hours, limits)
- `notification_history` - Delivery tracking and deduplication
- `subscription_expiration_prompts` - Expiration reminder tracking

## Dependencies Added

### Mobile App
```json
"expo-notifications": "~0.30.4"
```

### Backend
No new dependencies - uses Node.js built-in `https` module for Expo API calls.

## Testing Checklist

### Backend
- [ ] Token registration creates/updates push_tokens record
- [ ] Subscription creation with 30-day expiry
- [ ] Settings defaults (quiet hours 22:00-08:00, max 10/day)
- [ ] Deduplication prevents duplicate notifications
- [ ] Test notification endpoint sends successfully

### Mobile App
- [ ] Permission request dialog appears on first "Set Alert"
- [ ] Alert button shows "Alert Active" after subscription
- [ ] Notification appears when test notification sent
- [ ] Tapping notification navigates to formula finder
- [ ] Cancel alert removes subscription
- [ ] Spanish translations display correctly

### Integration
- [ ] Token registered on first subscription
- [ ] Multiple devices per user supported
- [ ] Quiet hours prevent notifications
- [ ] Daily limit enforced
- [ ] Subscription expiry works after 30 days

## Production Deployment Notes

1. **Expo Project Configuration**
   - Ensure `expo.extra.eas.projectId` is set in app.json
   - Required for Expo push notifications

2. **Backend Environment**
   - No additional env vars needed
   - Notification tables already migrated in migration 015

3. **Shortage Detection Integration**
   - Wire `FormulaRestockNotificationService.sendRestockAlerts()` into shortage detection cron job
   - Call when formula transitions from out-of-stock to in-stock

4. **Monitoring**
   - Track `notification_history` for delivery stats
   - Monitor failed tokens (deactivated count)
   - Alert on high failure rates

## Future Enhancements (Out of Scope)

- [ ] Geographic filtering (only notify for stores within radius)
- [ ] Custom notification frequency per user
- [ ] SMS fallback for users without push notifications
- [ ] Notification scheduling (batch send at specific times)
- [ ] Rich notifications with formula images
- [ ] Actionable notifications ("Add to Cart" button)

## Files Created

### Backend
```
backend/src/services/notifications/
├── NotificationRepository.ts          (362 lines)
├── PushNotificationService.ts         (261 lines)
├── FormulaRestockNotificationService.ts (214 lines)
└── index.ts                           (3 lines)

backend/src/routes/
└── notifications.ts                   (343 lines)
```

### Mobile App
```
app/lib/services/
└── notificationService.ts             (283 lines)

app/components/
└── FormulaAlertButton.tsx             (184 lines)
```

### Updates
```
backend/src/index.ts                   (2 imports added)
app/app/_layout.tsx                    (31 lines added)
app/app/formula/index.tsx              (13 lines added)
app/package.json                       (1 dependency added)
app/lib/i18n/translations/en.json      (16 strings added)
app/lib/i18n/translations/es.json      (16 strings added)
```

## Total Lines of Code: ~1,700 lines

## Related Documentation
- Database schema: `/backend/migrations/015_notification_system.sql`
- ROADMAP.md - A4.7 entry
- API documentation: See route file comments

## Success Metrics

**User Impact:**
- Reduces wasted trips to out-of-stock stores
- Enables proactive formula acquisition
- Decreases anxiety during shortages

**Technical:**
- Push notification delivery rate > 95%
- Alert latency < 5 minutes from restock detection
- Zero duplicate notifications per user per store per 30min window

---

**Implementation Date:** 2026-02-02
**Implemented By:** Claude Opus 4.5
**Status:** Ready for testing
