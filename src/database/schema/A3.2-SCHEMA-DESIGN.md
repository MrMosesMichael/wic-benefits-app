# A3.2 Schema Design - Store Data Structure

**Task:** Design store data schema (location, hours, features)
**Date:** January 21, 2026
**Status:** Complete

## Summary

Designed a comprehensive PostgreSQL schema for storing WIC-authorized store information across multiple states. The schema supports:

✅ Multi-state store inventory and location data
✅ Operating hours with holiday exceptions
✅ Store features and capabilities
✅ Geofence polygons for precise in-store detection
✅ Multiple detection methods (GPS, WiFi, Beacons)
✅ Temporal validity and data provenance tracking
✅ High-performance spatial queries (with PostGIS)
✅ Audit logging with updated_at timestamps

## Deliverables

### 1. TypeScript Type Definitions

**File:** `src/types/store.types.ts` (already exists)

Core types for store data:
- `Store`: Complete store entity with all relationships
- `Address`: Multi-line street address
- `GeoPoint`: Latitude/longitude coordinates
- `OperatingHours`: Weekly hours (Monday-Sunday)
- `HolidayHours`: Special hours for holidays
- `StoreFeatures`: Feature flags (pharmacy, deli, WIC kiosk, etc.)
- `WiFiNetwork`: SSID and BSSID for WiFi-based detection
- `Beacon`: iBeacon UUIDs for proximity detection
- `Geofence`: Circle or polygon boundaries for in-store detection
- `StoreDetectionResult`: Result of store detection algorithm

### 2. PostgreSQL Schema

**File:** `src/database/schema/stores.schema.sql`

#### Tables

**`stores`** (Main store table)
- UUID primary key with auto-generation
- Basic info: name, chain, chain_id
- Location: street, city, state, ZIP, country, lat/lng
- Contact: phone, website
- WIC info: wic_authorized flag, wic_vendor_id (state-specific)
- Features: stored as JSONB for flexibility
- Inventory API: available flag and type (walmart/kroger/target/scrape)
- Detection methods: wifi_networks and beacons (JSONB arrays)
- Timezone for hours calculations
- Data provenance: data_source (api/scrape/crowdsourced/manual), last_verified
- Status: active flag
- Audit: created_at, updated_at

**`store_hours`** (Weekly operating hours)
- UUID primary key
- Foreign key to stores (CASCADE delete)
- Day of week (0=Sunday, 6=Saturday)
- Open time and close time (or NULL if closed)
- Closed flag for simpler closed days
- Audit timestamps

**`store_holiday_hours`** (Special hours for holidays)
- UUID primary key
- Foreign key to stores (CASCADE delete)
- Holiday date (ISO date)
- Open/close times or closed flag
- Reason text (e.g., "Thanksgiving", "Inventory Day")
- Unique constraint on (store_id, holiday_date)
- Audit timestamps

**`store_geofences`** (Geofence definitions)
- UUID primary key
- Foreign key to stores (CASCADE delete)
- Geofence type: "circle" or "polygon"
- For circles: center_latitude, center_longitude, radius_meters
- For polygons: polygon_coordinates (JSONB array of points)
- Check constraint ensuring correct data for geofence type
- Audit timestamps

#### Indexes

**Location-based queries:**
- `idx_stores_state`: Filter by state
- `idx_stores_city`: Filter by city
- `idx_stores_zip`: Filter by ZIP code
- `idx_stores_location`: Earth distance index (requires PostGIS earthdistance extension)

**WIC and features:**
- `idx_stores_wic_authorized`: Quick filter for WIC-authorized stores
- `idx_stores_wic_vendor_id`: Lookup by state vendor ID
- `idx_stores_chain`: Filter by chain

**Data quality:**
- `idx_stores_active`: Filter for active stores only
- `idx_stores_last_verified`: Sort by verification recency

**Relationship indexes:**
- `idx_store_hours_store`: Hours lookup by store and day
- `idx_holiday_hours_store_date`: Holiday hours lookup
- `idx_geofences_store`: Geofence lookup by store

#### Views

**`stores_with_hours`**
- Joins store with today's operating hours
- Automatically selects correct hours based on current day of week

**`stores_complete_data`**
- Filters for stores with all required location fields
- Useful for reports and data quality checks

#### Functions

**`update_updated_at_column()`**
- Trigger function to auto-update `updated_at` on modification
- Applied to all tables

**`find_wic_stores_by_state(p_state)`**
- Returns WIC-authorized stores for a state
- Returns: id, name, address_street, address_city, phone, latitude, longitude

**`is_store_open(p_store_id)`**
- Determines if a store is currently open
- Handles timezone-aware calculations
- Considers holiday hours before regular hours
- Returns: true/false/null (null if no hours defined)

### 3. TypeScript Repository Class

**File:** `src/database/StoreRepository.ts`

Database abstraction layer for store operations:

**Create Operations:**
- `createStore()`: Insert new store with all data

**Read Operations:**
- `getStoreById()`: Fetch store by UUID
- `getStoresByState()`: List all WIC-authorized stores in a state
- `getStoresNearby()`: Spatial query for stores within distance (requires PostGIS)
- `getStoresByChain()`: Filter stores by chain name
- `getOperatingHours()`: Fetch hours for a store
- `getGeofences()`: Fetch geofences for a store
- `findWICStoresByState()`: Use database function

**Update Operations:**
- `updateStore()`: Partial updates to store data
- `addOperatingHours()`: Add or update weekly hours (upsert)
- `addHolidayHours()`: Add or update holiday hours (upsert)

**Query Operations:**
- `isStoreOpen()`: Check current open status
- `addGeofence()`: Add circle or polygon geofence

**Internal Methods:**
- `parseStoreRow()`: Convert database row to Store object
- `enrichStoreWithRelations()`: Load hours and geofences

### 4. Validation Utilities

**File:** `src/utils/store.validation.ts`

Comprehensive data validation:

**Validation Functions:**
- `validateStore()`: Full store entity validation
- `validateAddress()`: Address field validation
- `validateGeoPoint()`: Latitude/longitude bounds checking
- `validateOperatingHours()`: Hours format and logic
- `validateHolidayHours()`: Holiday hours validation
- `validateStoreFeatures()`: Feature flag validation

**Utility Functions:**
- `isValidTime()`: HH:MM format validation
- `isValidDate()`: ISO date format (YYYY-MM-DD) validation
- `isValidZip()`: ZIP code format (5 or 9 digit) validation
- `isValidTimezone()`: Timezone validity check

**Sanitization:**
- `sanitizeStore()`: Clean store data for database
- `sanitizeAddress()`: Normalize address components

**Geospatial:**
- `calculateDistance()`: Haversine formula for meters distance
- `isPointInPolygon()`: Ray casting algorithm for polygon membership
- `isPointInCircle()`: Circle boundary checking

## Data Model Relationships

```
┌──────────────────┐
│     stores       │
├──────────────────┤
│ id (UUID, PK)    │
│ name             │
│ chain            │
│ address_*        │
│ latitude         │
│ longitude        │
│ wic_authorized   │
│ ... (20+ fields) │
└────────┬─────────┘
         │
         ├─────────────────────────┬──────────────────┐
         │                         │                  │
    ┌────▼──────────┐  ┌──────────▼──────┐  ┌────────▼──────────┐
    │ store_hours   │  │ store_holiday_   │  │ store_geofences  │
    │               │  │ hours            │  │                  │
    │ M:1 to stores │  │                  │  │ M:1 to stores    │
    └───────────────┘  │ M:1 to stores    │  └──────────────────┘
                       └──────────────────┘
```

## Key Design Decisions

### 1. Separate Hours Tables

**Decision:** Store operating hours and holiday hours in separate tables

**Rationale:**
- Normalize data (avoid weekly hours duplication)
- Efficient queries for current hours
- Easy to update individual days without touching entire schedule
- Holiday hours as exceptions without modifying regular schedule

**Alternative:** Single JSON hours field
- Simpler schema but harder to query
- Less efficient indexing

### 2. Geofence as Optional Relationship

**Decision:** Geofences in separate table with optional reference

**Rationale:**
- Not all stores need geofences initially
- Can add later without schema changes
- Support multiple geofence types (circle/polygon)
- Clean separation of concerns

### 3. Features as JSONB

**Decision:** Store features as single JSONB column

**Rationale:**
- Boolean flags (pharmacy, deli, etc.) don't need normalization
- Flexibility to add new features without migration
- GIN index support for efficient queries
- Single atomic update for all features

**Alternative:** Separate feature columns
- Explicit schema but verbose
- Harder to add new features

### 4. Two Data Source Types

**Decision:** Track both detection methods (wifi_networks, beacons) and data source (api/scrape/crowdsourced)

**Rationale:**
- `data_source`: Where store info came from (provenance)
- `wifi_networks` / `beacons`: Detection methods available at store (capability)
- Different concerns, both needed for store detection

### 5. Timezone-Aware Hours

**Decision:** Store timezone separately, use functions for open/closed checks

**Rationale:**
- Stores operate in local timezone
- Database can check hours in store's timezone, not UTC
- `is_store_open()` function handles timezone conversion
- Correct behavior across DST changes

## PostGIS Integration (Optional)

The schema is designed to work with PostGIS for advanced spatial queries:

```sql
-- Enable PostGIS (one-time)
CREATE EXTENSION IF NOT EXISTS postgis;

-- Example: Find all WIC stores within 5km of user location
SELECT * FROM stores
WHERE ST_DWithin(
  ST_SetSRID(ST_Point(latitude, longitude), 4326)::geography,
  ST_SetSRID(ST_Point(user_lat, user_lng), 4326)::geography,
  5000  -- 5000 meters
)
AND wic_authorized = true
ORDER BY ST_Distance(
  ST_SetSRID(ST_Point(latitude, longitude), 4326)::geography,
  ST_SetSRID(ST_Point(user_lat, user_lng), 4326)::geography
);
```

The earthdistance extension is currently configured but PostGIS is fully compatible.

## Performance Characteristics

| Operation | Index | Time |
|-----------|-------|------|
| Get store by ID | PK | O(1) |
| List WIC stores by state | idx_stores_wic_authorized + idx_stores_state | O(n) where n = stores in state |
| Find nearby stores (5km) | idx_stores_location | O(log n) with PostGIS |
| Check if open now | PK + store_hours index | O(1) |
| Get hours for day | idx_store_hours_store | O(1) |
| Holiday hours lookup | idx_holiday_hours_store_date | O(1) |

## Security Considerations

1. **Data Privacy:** Stores are public data (addresses, hours), no PII
2. **Write Access:** Only admins/data sync processes should insert/update
3. **Timezone Validation:** Database validates timezone against Intl API
4. **Geographic Validation:** Check constraints ensure valid lat/lng bounds
5. **Data Integrity:** Foreign key constraints ensure referential integrity

## Example Queries

```sql
-- Find all WIC stores in Michigan
SELECT * FROM stores
WHERE address_state = 'MI' AND wic_authorized = true;

-- Get Walmart stores with current hours
SELECT s.*, sh.open_time, sh.close_time
FROM stores_with_hours s
WHERE s.chain = 'walmart' AND s.active = true;

-- Check if specific store is open right now
SELECT is_store_open('550e8400-e29b-41d4-a716-446655440000'::uuid);

-- Find all closed/inactive stores (data quality check)
SELECT id, name, active
FROM stores
WHERE active = false OR last_verified < NOW() - INTERVAL '30 days';

-- Get stores with all required location data
SELECT * FROM stores_complete_data
WHERE address_state = 'NC';
```

## Migration Notes

When applying this schema:

1. **Create types and tables** (stores.schema.sql)
2. **Create indexes** (automatic from schema)
3. **Create functions and triggers** (automatic from schema)
4. **Seed initial data** (separate SQL file with state retailer data)
5. **Enable PostGIS** (optional, for spatial queries)

## Next Steps (A3.3+)

1. **Data Ingestion (A3.3):** Build pipeline to populate stores from:
   - WIC state authorized retailer lists (A3.1)
   - Google Places API
   - Walmart API
   - Manual entry for unlisted stores

2. **Search API (A3.5):** Create REST endpoints:
   - GET /stores/nearby?lat=X&lng=Y
   - GET /stores/state/{state}
   - GET /stores/{storeId}
   - POST /stores/search

3. **Data Enrichment (A3.4):** Integrate with Google Places for:
   - Photos
   - Reviews
   - Website links
   - Real-time hours

4. **Inventory Integration (I1-I9):** Link to product availability data
