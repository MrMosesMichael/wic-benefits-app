# A1.2 Schema Design - APL Data Structure

**Task:** Design APL data schema (UPC, eligibility, restrictions, participant types)
**Date:** January 20, 2026
**Status:** Complete

## Summary

Designed a comprehensive PostgreSQL schema for storing WIC Approved Product List (APL) data across multiple states. The schema supports:

✅ Multi-state eligibility tracking
✅ Complex size/brand/nutrition restrictions
✅ Temporal validity (effective/expiration dates)
✅ UPC normalization (handles format variations)
✅ Change detection and audit logging
✅ Data quality tracking and verification
✅ High-performance queries with optimized indexes

## Deliverables

### 1. TypeScript Type Definitions
**File:** `src/types/apl.types.ts`

Comprehensive type system including:
- `APLEntry`: Core product eligibility entry
- `SizeRestriction`: Min/max/exact size rules
- `BrandRestriction`: Allowed/excluded/contract brands
- `AdditionalRestrictions`: State-specific nutrition rules
- `APLSyncStatus`: Sync health tracking
- `APLChangeLog`: Audit trail
- `UPCVariants`: Normalized UPC formats
- `APLQueryParams`: Structured query interface
- `APLLookupResult`: Eligibility check result

**Key Features:**
- Strong typing for data integrity
- JSONB-compatible structures for flexibility
- Comprehensive documentation in JSDoc format

### 2. PostgreSQL Schema
**File:** `src/database/schema/apl.schema.sql`

**Tables:**
- `apl_entries`: Core APL data (4,000+ rows per state expected)
- `apl_sync_status`: Sync health monitoring (1 row per state/source)
- `apl_change_log`: Audit trail (grows over time)
- `state_benefit_categories`: Category name mappings
- `upc_variants`: UPC normalization cache

**Indexes:**
- B-tree indexes on state, UPC, category, dates
- GIN indexes on JSONB restriction fields
- Partial index for current entries (most common query)
- Full-text search on categories and notes

**Views:**
- `apl_entries_current`: Currently-valid entries (filtered)
- `apl_sync_health`: Sync status dashboard
- `apl_recent_changes`: Last 30 days of changes

**Functions:**
- `normalize_upc()`: UPC format standardization
- `lookup_apl_by_upc()`: Intelligent UPC lookup with variants
- `update_updated_at_column()`: Auto-update timestamps

### 3. Utility Functions
**File:** `src/utils/upc.utils.ts`

UPC normalization utilities:
- `normalizeUPC()`: Convert any UPC format to standard variants
- `expandUPCE()`: Expand UPC-E (8-digit) to UPC-A (12-digit)
- `calculateCheckDigit()`: Compute UPC check digit
- `validateCheckDigit()`: Verify UPC validity
- `generateUPCVariants()`: Create search variants for database
- `formatUPCForDisplay()`: Human-readable UPC format
- `areUPCsEquivalent()`: Compare UPCs across formats

**File:** `src/utils/apl.validation.ts`

Data validation and sanitization:
- `validateAPLEntry()`: Complete entry validation
- `validateUPC()`: UPC format validation
- `validateParticipantTypes()`: Participant type validation
- `validateSizeRestriction()`: Size rule validation
- `validateBrandRestriction()`: Brand rule validation
- `validateAdditionalRestrictions()`: Nutrition rule validation
- `sanitizeAPLEntry()`: Clean and normalize data before storage

### 4. Documentation
**File:** `src/database/schema/README.md`

Comprehensive documentation covering:
- Schema design principles
- Table descriptions and relationships
- Index strategies and performance optimization
- Common query patterns
- Data source information
- Maintenance procedures

**File:** `src/database/schema/example-data.sql`

Sample data demonstrating:
- Cereal entries (simple eligibility)
- Milk entries (size restrictions)
- Infant formula (contract brands with dates)
- Florida-specific rules (no artificial dyes)
- Sync status examples
- Change log examples
- UPC variant examples

## Design Decisions

### 1. JSONB for Restrictions
**Decision:** Use PostgreSQL JSONB for size/brand/additional restrictions instead of separate tables.

**Rationale:**
- State-specific rules vary widely (MI ≠ NC ≠ FL ≠ OR)
- Adding new restriction types doesn't require schema migration
- GIN indexes enable fast queries on JSONB fields
- TypeScript types provide structure without DB rigidity

**Trade-off:** Less normalized, but more flexible and performant for this use case.

### 2. Temporal Validity
**Decision:** Store `effective_date` and `expiration_date` on each entry.

**Rationale:**
- Products come and go from APL over time
- Contract brands have defined validity periods
- Need point-in-time queries ("Was X eligible on date Y?")
- Simplifies sync logic (add new entry, expire old one)

### 3. UPC Normalization
**Decision:** Store UPCs in normalized 12-digit format, but support lookup by any variant.

**Rationale:**
- UPCs appear as 8, 12, 13, or 14 digits in various sources
- Leading zeros are inconsistent (11110416605 vs 011110416605)
- `lookup_apl_by_upc()` function handles all variants automatically
- `upc_variants` table caches normalization for performance

### 4. Change Logging
**Decision:** Store JSONB snapshots of previous/new entries in change log.

**Rationale:**
- Full audit trail without complex joins
- Can reconstruct APL state at any point in history
- Useful for debugging sync issues
- Enables "What changed?" notifications to users

### 5. State Independence
**Decision:** Separate APL entries per state (no shared entries).

**Rationale:**
- Same UPC may be eligible in one state, not another
- Size limits vary by state (MI allows 8.9-36oz cereal, NC allows 12-24oz)
- Contract brands differ by state
- Simplifies queries (always filter by state)

## Data Flow

```
┌─────────────────────────────────────────┐
│     Data Sources                        │
│  (Excel, PDF, Web, FTP)                 │
└───────────────┬─────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│     Ingestion Workers                   │
│  (Parse, Normalize, Validate)           │
│  - A1.3: Michigan (FIS)                 │
│  - A1.4: North Carolina (Conduent)      │
│  - A1.5: Florida (FIS)                  │
│  - A1.6: Oregon (State)                 │
└───────────────┬─────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│     Validation Layer                    │
│  (apl.validation.ts)                    │
│  - UPC normalization                    │
│  - Required field checks                │
│  - Restriction validation               │
│  - Sanitization                         │
└───────────────┬─────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│     PostgreSQL Database                 │
│  Tables:                                │
│  - apl_entries                          │
│  - apl_sync_status                      │
│  - apl_change_log                       │
│  - state_benefit_categories             │
│  - upc_variants                         │
└───────────────┬─────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│     Application Layer                   │
│  - Eligibility checks                   │
│  - Product browsing                     │
│  - Alternative suggestions              │
│  - Change notifications                 │
└─────────────────────────────────────────┘
```

## Performance Characteristics

### Query Performance

**Most Common Query:** Check product eligibility
```sql
SELECT * FROM lookup_apl_by_upc('11110416605', 'MI', NOW());
```
- **Index Used:** `idx_apl_entries_current` (partial index)
- **Expected Rows:** 1
- **Performance:** <5ms

**Category Browsing:**
```sql
SELECT * FROM apl_entries_current WHERE state = 'MI' AND benefit_category = 'Cereal';
```
- **Index Used:** `idx_apl_entries_category`
- **Expected Rows:** 50-200
- **Performance:** <10ms

**State-wide Queries:**
```sql
SELECT COUNT(*) FROM apl_entries_current WHERE state = 'NC';
```
- **Index Used:** `idx_apl_entries_state`
- **Expected Rows:** 3,000-5,000
- **Performance:** <20ms

### Storage Estimates

**Per State:**
- 4,000 products × 1KB per row = ~4MB per state
- With indexes: ~12MB per state
- 4 states: ~48MB total (minimal)

**Change Log Growth:**
- Assume 100 changes/day/state = 400 changes/day
- 400 × 2KB per entry = 800KB/day
- 1 year = ~292MB (manageable)

**Recommended Retention:** Archive change logs older than 2 years.

## State-Specific Considerations

### Michigan (FIS)
- **Format:** Excel (.xlsx)
- **Size Restrictions:** Min/max ranges (8.9-36oz for cereal)
- **Update Frequency:** Monthly public, daily vendor portal
- **Special Rules:** Whole grain requirements, sugar limits

### North Carolina (Conduent)
- **Format:** Web/FTP
- **Size Restrictions:** Exact sizes or ranges (12-24oz for cereal)
- **Update Frequency:** Rolling updates
- **Special Rules:** Nutrition criteria by category

### Florida (FIS)
- **Format:** PDF
- **Size Restrictions:** Similar to Michigan
- **Update Frequency:** Phased rollout (Oct 2025 - Mar 2026)
- **Special Rules:** **No artificial food dyes** (unique to FL)

### Oregon (State-Specific)
- **Format:** Excel (.xlsx)
- **Size Restrictions:** Min/max ranges
- **Update Frequency:** Quarterly major, ongoing minor
- **Special Rules:** Frequent additions (900+ new UPCs in July 2025)

## Next Steps

### Immediate (Remaining A1 Tasks)

**A1.3** - Build Michigan APL ingestion
- Parse Excel file from michigan.gov/mdhhs
- Extract UPC, category, size, participant types
- Validate and normalize data
- Insert into `apl_entries` table
- Update `apl_sync_status`

**A1.4** - Build North Carolina APL ingestion
- Scrape ncdhhs.gov/ncwicfoods or access Conduent FTP
- Parse web data or structured file
- Map category names to canonical
- Insert with `data_source = 'conduent'`

**A1.5** - Build Florida APL ingestion
- Parse PDF from floridahealth.gov
- Extract product lists by category
- Handle artificial dyes policy (effective Oct 2025)
- Mark old entries with expiration dates

**A1.6** - Build Oregon APL ingestion
- Parse Excel from oregon.gov/oha
- Handle frequent updates (900+ additions in single update)
- Insert with `data_source = 'state'`

**A1.7** - Design state eligibility rules engine
- Build rule evaluation system
- Handle complex conditions (size AND brand AND nutrition)
- Support participant type filtering
- Cache rules for performance

**A1.8** - Create APL update monitoring
- Schedule daily/weekly sync jobs
- Detect source file changes (hash comparison)
- Alert on sync failures
- Track metrics (additions/updates/removals)

### Future Enhancements

- **USDA NUPC Integration:** Use national database for validation
- **Crowdsourced Corrections:** Allow users to report discrepancies
- **Real-time Sync:** WebSocket updates for APL changes
- **Multi-state Expansion:** Add remaining 46+ states/territories
- **API Rate Limiting:** Protect database from excessive queries
- **Read Replicas:** Scale read-heavy workloads

## Testing Recommendations

1. **UPC Normalization:**
   - Test all UPC formats (8, 12, 13, 14 digits)
   - Test with/without leading zeros
   - Test check digit validation

2. **Eligibility Lookup:**
   - Test current vs expired entries
   - Test UPC variants matching
   - Test state filtering
   - Test participant type filtering

3. **Restriction Validation:**
   - Test exact size matching
   - Test min/max range validation
   - Test brand allow/exclude lists
   - Test contract brand date ranges

4. **Change Detection:**
   - Test addition, removal, modification
   - Test expiration handling
   - Test reinstated products

5. **Sync Health:**
   - Test failure detection
   - Test staleness alerts
   - Test consecutive failure tracking

## Files Created

```
src/
├── types/
│   └── apl.types.ts              (TypeScript type definitions)
├── utils/
│   ├── upc.utils.ts              (UPC normalization utilities)
│   └── apl.validation.ts         (Data validation utilities)
└── database/
    └── schema/
        ├── apl.schema.sql        (PostgreSQL schema)
        ├── example-data.sql      (Sample data and queries)
        ├── README.md             (Comprehensive documentation)
        └── A1.2-SCHEMA-DESIGN.md (This file)
```

## Metrics

- **Lines of Code:** ~2,000
- **Database Tables:** 5
- **Database Views:** 3
- **Database Functions:** 3
- **TypeScript Interfaces:** 15+
- **Utility Functions:** 15+
- **Documentation:** 4 files, ~1,500 lines

---

**Task A1.2 Complete** ✅

Ready to proceed with:
- **A1.3:** Michigan APL ingestion (FIS processor)
- **A1.4:** North Carolina APL ingestion (Conduent processor)
- **A1.5:** Florida APL ingestion (FIS processor)
- **A1.6:** Oregon APL ingestion (state-specific system)
