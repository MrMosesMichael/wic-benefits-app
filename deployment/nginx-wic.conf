# nginx configuration for WIC app at https://mdmichael.com/wic/
# Place this in your nginx config directory (e.g., /etc/nginx/sites-available/)
# or include it in your existing mdmichael.com server block

# Upstream for WIC backend
upstream wic_backend {
    server 127.0.0.1:3000;
    keepalive 32;
}

# Add this inside your existing server block for mdmichael.com
# If you're running nginx in Docker, you'll need to adjust network references

# WIC API endpoints - proxy to backend container
location /wic/api/ {
    # Rewrite /wic/api/v1/... to /api/v1/...
    rewrite ^/wic(/api/.*)$ $1 break;

    proxy_pass http://wic_backend;
    proxy_http_version 1.1;

    # Headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";

    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Buffering
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;

    # CORS headers (if needed, though backend handles CORS)
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";
}

# WIC health check endpoint
location /wic/health {
    rewrite ^/wic(/health)$ $1 break;
    proxy_pass http://wic_backend;
    proxy_http_version 1.1;
    access_log off;  # Don't log health checks
}

# WIC landing page
location = /wic/ {
    alias /var/www/wic/index.html;
}

# Serve static assets (if needed)
location /wic/static/ {
    alias /var/www/wic/static/;
    expires 1y;
    add_header Cache-Control "public, immutable";
}
